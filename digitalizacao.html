<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Página da Digitalização</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="layout.css">
</head>
<body>

  <div id="app">
    <h1>Página da Digitalização</h1>

    <button id="btnCarregar">Carregar</button>
    <input type="file" id="fileInput" accept=".obj" style="display:none">

    <button id="btnConverter">Converter</button>

    <button id="btnMenu">Menu</button>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { OBJLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/OBJLoader.js";
    import { GLTFExporter } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/exporters/GLTFExporter.js";

    const btnCarregar = document.getElementById('btnCarregar');
    const btnConverter = document.getElementById('btnConverter');
    const fileInput = document.getElementById('fileInput');

    let nomeOBJ = null;

    btnCarregar.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      nomeOBJ = file.name;

      const cache = await caches.open('digitalizacao-cache');
      await cache.put(nomeOBJ, new Response(file));

      alert("Arquivo carregado");
    });

    btnConverter.addEventListener('click', async () => {
      if (!nomeOBJ) return;

      const cache = await caches.open('digitalizacao-cache');
      const response = await cache.match(nomeOBJ);
      if (!response) return;

      const objText = await response.text();

      const loader = new OBJLoader();
      const object = loader.parse(objText);

      const exporter = new GLTFExporter();
      exporter.parse(
        object,
        async (result) => {
          const glbBlob = new Blob([result], { type: 'model/gltf-binary' });
          const glbName = nomeOBJ.replace('.obj', '.glb');

          await cache.put(glbName, new Response(glbBlob));

          const url = URL.createObjectURL(glbBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = glbName;
          a.click();
          URL.revokeObjectURL(url);

          alert("Arquivo convertido");
        },
        { binary: true }
      );
    });

    document.getElementById('btnMenu').addEventListener('click', () => {
      window.location.href = 'index.html';
    });
  </script>

</body>
</html>
